import h5py
import numpy as np
import os

####

from mcdc.reaction import (
    ReactionElectronBremsstrahlung,
    ReactionElectronExcitation,
    ReactionElectronElasticScattering,
    ReactionElectronIonization,
    decode_type,
)
from mcdc.objects import ObjectNonSingleton
from mcdc.prints import print_1d_array

# ======================================================================================
# Element class
# ======================================================================================


class Element(ObjectNonSingleton):
    def __init__(self, element_name):
        label = "element"
        super().__init__(label)

        # Set attributes from the hdf5 file
        dir_name = os.getenv("MCDC_ELECTRON_XSLIB")
        file_name = f"{element_name}.h5"
        with h5py.File(f"{dir_name}/{file_name}", "r") as f:
            self.name = f["element_name"][()].decode()
            self.atomic_number = f["atomic_number"][()]
            self.xs_energy_grid = f["electron_reactions/xs_energy_grid"][()]

            self.reactions = []
            self.total_xs = np.zeros_like(self.xs_energy_grid)

            for reaction_type in f["electron_reactions"]:
                if reaction_type == "xs_energy_grid":
                    continue

                if reaction_type == "bremsstrahlung":
                    ReactionClass = ReactionElectronBremsstrahlung

                elif reaction_type == "excitation":
                    ReactionClass = ReactionElectronExcitation

                elif reaction_type == "elastic_scattering":
                    ReactionClass = ReactionElectronElasticScattering

                elif reaction_type == "ionization":
                    ReactionClass = ReactionElectronIonization

                reaction = ReactionClass.from_h5_group(f[f"electron_reactions/{reaction_type}"])
                self.reactions.append(reaction)

                # Accumulate total XS
                self.total_xs += reaction.xs

    def __repr__(self):
        text = "\n"
        text += "Element\n"
        text += f"  - ID: {self.ID}\n"
        text += f"  - Name: {self.name}\n"
        text += f"  - Atomic number (Z): {self.atomic_number}\n"
        text += f"  - XS energy grid {print_1d_array(self.xs_energy_grid)} eV\n"
        text += "  - Reactions\n"
        for reaction in self.reactions:
            text += f"    - {decode_type(reaction.type)}\n"
        return text


# For future use
ISOTOPIC_ABUNDANCE = {
    "H": {
        "H1": (99.972 + 99.999) / 2,
        "H2": (0.001 + 0.028) / 2,
    },
    "He": {
        "He3": (0.0002 + 0.0002) / 2,
        "He4": (99.9998 + 99.9998) / 2,
    },
    "Li": {
        "Li6": (1.9 + 7.8) / 2,
        "Li7": (92.2 + 98.1) / 2,
    },
    "Be": {
        "Be9": 100.0,
    },
    "B": {
        "B10": (18.9 + 20.4) / 2,
        "B11": (79.6 + 81.1) / 2,
    },
    "C": {
        "C12": (98.84 + 99.04) / 2,
        "C13": (0.96 + 1.16) / 2,
    },
    "N": {
        "N14": (99.578 + 99.663) / 2,
        "N15": (0.337 + 0.422) / 2,
    },
    "O": {
        "O16": (99.738 + 99.776) / 2,
        "O17": (0.0367 + 0.04) / 2,
        "O18": (0.187 + 0.222) / 2,
    },
    "F": {
        "F19": 100.0,
    },
    "Ne": {
        "Ne20": (90.48 + 90.48) / 2,
        "Ne21": (0.27 + 0.27) / 2,
        "Ne22": (9.25 + 9.25) / 2,
    },
    "Na": {
        "Na23": 100.0,
    },
    "Mg": {
        "Mg24": (78.88 + 79.05) / 2,
        "Mg25": (9.988 + 10.034) / 2,
        "Mg26": (10.96 + 11.09) / 2,
    },
    "Al": {
        "Al27": 100.0,
    },
    "Si": {
        "Si28": (92.191 + 92.318) / 2,
        "Si29": (4.645 + 4.699) / 2,
        "Si30": (3.037 + 3.11) / 2,
    },
    "P": {
        "P31": 100.0,
    },
    "S": {
        "S32": (94.41 + 95.29) / 2,
        "S33": (0.729 + 0.797) / 2,
        "S34": (3.96 + 4.77) / 2,
        "S36": (0.0129 + 0.0187) / 2,
    },
    "Cl": {
        "Cl35": (75.5 + 76.1) / 2,
        "Cl37": (23.9 + 24.5) / 2,
    },
    "Ar": {
        "Ar36": (0.3336 + 0.3336) / 2,
        "Ar38": (0.0629 + 0.0629) / 2,
        "Ar40": (99.6035 + 99.6035) / 2,
    },
    "K": {
        "K39": (93.2581 + 93.2581) / 2,
        "K40": (0.0117 + 0.0117) / 2,
        "K41": (6.7302 + 6.7302) / 2,
    },
    "Ca": {
        "Ca40": (96.941 + 96.941) / 2,
        "Ca42": (0.647 + 0.647) / 2,
        "Ca43": (0.135 + 0.135) / 2,
        "Ca44": (2.086 + 2.086) / 2,
        "Ca46": (0.004 + 0.004) / 2,
        "Ca48": (0.187 + 0.187) / 2,
    },
    "Sc": {
        "Sc45": 100.0,
    },
    "Ti": {
        "Ti46": (8.25 + 8.25) / 2,
        "Ti47": (7.44 + 7.44) / 2,
        "Ti48": (73.72 + 73.72) / 2,
        "Ti49": (5.41 + 5.41) / 2,
        "Ti50": (5.18 + 5.18) / 2,
    },
    "V": {
        "V50": (0.25 + 0.25) / 2,
        "V51": (99.75 + 99.75) / 2,
    },
    "Cr": {
        "Cr50": (4.345 + 4.345) / 2,
        "Cr52": (83.789 + 83.789) / 2,
        "Cr53": (9.501 + 9.501) / 2,
        "Cr54": (2.365 + 2.365) / 2,
    },
    "Mn": {
        "Mn55": 100.0,
    },
    "Fe": {
        "Fe54": (5.845 + 5.845) / 2,
        "Fe56": (91.754 + 91.754) / 2,
        "Fe57": (2.119 + 2.119) / 2,
        "Fe58": (0.282 + 0.282) / 2,
    },
    "Co": {
        "Co59": 100.0,
    },
    "Ni": {
        "Ni58": (68.0769 + 68.0769) / 2,
        "Ni60": (26.2231 + 26.2231) / 2,
        "Ni61": (1.1399 + 1.1399) / 2,
        "Ni62": (3.6345 + 3.6345) / 2,
        "Ni64": (0.9256 + 0.9256) / 2,
    },
    "Cu": {
        "Cu63": (69.15 + 69.15) / 2,
        "Cu65": (30.85 + 30.85) / 2,
    },
    "Zn": {
        "Zn64": (49.17 + 49.17) / 2,
        "Zn66": (27.73 + 27.73) / 2,
        "Zn67": (4.04 + 4.04) / 2,
        "Zn68": (18.45 + 18.45) / 2,
        "Zn70": (0.61 + 0.61) / 2,
    },
    "Ga": {
        "Ga69": (60.108 + 60.108) / 2,
        "Ga71": (39.892 + 39.892) / 2,
    },
    "Ge": {
        "Ge70": (20.52 + 20.52) / 2,
        "Ge72": (27.45 + 27.45) / 2,
        "Ge73": (7.76 + 7.76) / 2,
        "Ge74": (36.52 + 36.52) / 2,
        "Ge76": (7.75 + 7.75) / 2,
    },
    "As": {
        "As75": 100.0,
    },
    "Se": {
        "Se74": (0.86 + 0.86) / 2,
        "Se76": (9.23 + 9.23) / 2,
        "Se77": (7.6 + 7.6) / 2,
        "Se78": (23.69 + 23.69) / 2,
        "Se80": (49.8 + 49.8) / 2,
        "Se82": (8.82 + 8.82) / 2,
    },
    "Br": {
        "Br79": (50.5 + 50.8) / 2,
        "Br81": (49.2 + 49.5) / 2,
    },
    "Kr": {
        "Kr78": (0.355 + 0.355) / 2,
        "Kr80": (2.286 + 2.286) / 2,
        "Kr82": (11.593 + 11.593) / 2,
        "Kr83": (11.5 + 11.5) / 2,
        "Kr84": (56.987 + 56.987) / 2,
        "Kr86": (17.279 + 17.279) / 2,
    },
    "Rb": {
        "Rb85": (72.17 + 72.17) / 2,
        "Rb87": (27.83 + 27.83) / 2,
    },
    "Sr": {
        "Sr84": (0.56 + 0.56) / 2,
        "Sr86": (9.86 + 9.86) / 2,
        "Sr87": (7.0 + 7.0) / 2,
        "Sr88": (82.58 + 82.58) / 2,
    },
    "Y": {
        "Y89": 100.0,
    },
    "Zr": {
        "Zr90": (51.45 + 51.45) / 2,
        "Zr91": (11.22 + 11.22) / 2,
        "Zr92": (17.15 + 17.15) / 2,
        "Zr94": (17.38 + 17.38) / 2,
        "Zr96": (2.8 + 2.8) / 2,
    },
    "Nb": {
        "Nb93": 100.0,
    },
    "Mo": {
        "Mo92": (14.649 + 14.649) / 2,
        "Mo94": (9.187 + 9.187) / 2,
        "Mo95": (15.873 + 15.873) / 2,
        "Mo96": (16.673 + 16.673) / 2,
        "Mo97": (9.582 + 9.582) / 2,
        "Mo98": (24.292 + 24.292) / 2,
        "Mo100": (9.744 + 9.744) / 2,
    },
    "Ru": {
        "Ru96": (5.54 + 5.54) / 2,
        "Ru98": (1.87 + 1.87) / 2,
        "Ru99": (12.76 + 12.76) / 2,
        "Ru100": (12.6 + 12.6) / 2,
        "Ru101": (17.06 + 17.06) / 2,
        "Ru102": (31.55 + 31.55) / 2,
        "Ru104": (18.62 + 18.62) / 2,
    },
    "Rh": {
        "Rh103": 100.0,
    },
    "Pd": {
        "Pd102": (1.02 + 1.02) / 2,
        "Pd104": (11.14 + 11.14) / 2,
        "Pd105": (22.33 + 22.33) / 2,
        "Pd106": (27.33 + 27.33) / 2,
        "Pd108": (26.46 + 26.46) / 2,
        "Pd110": (11.72 + 11.72) / 2,
    },
    "Ag": {
        "Ag107": (51.839 + 51.839) / 2,
        "Ag109": (48.161 + 48.161) / 2,
    },
    "Cd": {
        "Cd106": (1.245 + 1.245) / 2,
        "Cd108": (0.888 + 0.888) / 2,
        "Cd110": (12.47 + 12.47) / 2,
        "Cd111": (12.795 + 12.795) / 2,
        "Cd112": (24.109 + 24.109) / 2,
        "Cd113": (12.227 + 12.227) / 2,
        "Cd114": (28.754 + 28.754) / 2,
        "Cd116": (7.512 + 7.512) / 2,
    },
    "In": {
        "In113": (4.281 + 4.281) / 2,
        "In115": (95.719 + 95.719) / 2,
    },
    "Sn": {
        "Sn112": (0.97 + 0.97) / 2,
        "Sn114": (0.66 + 0.66) / 2,
        "Sn115": (0.34 + 0.34) / 2,
        "Sn116": (14.54 + 14.54) / 2,
        "Sn117": (7.68 + 7.68) / 2,
        "Sn118": (24.22 + 24.22) / 2,
        "Sn119": (8.59 + 8.59) / 2,
        "Sn120": (32.58 + 32.58) / 2,
        "Sn122": (4.63 + 4.63) / 2,
        "Sn124": (5.79 + 5.79) / 2,
    },
    "Sb": {
        "Sb121": (57.21 + 57.21) / 2,
        "Sb123": (42.79 + 42.79) / 2,
    },
    "Te": {
        "Te120": (0.09 + 0.09) / 2,
        "Te122": (2.55 + 2.55) / 2,
        "Te123": (0.89 + 0.89) / 2,
        "Te124": (4.74 + 4.74) / 2,
        "Te125": (7.07 + 7.07) / 2,
        "Te126": (8.84 + 8.84) / 2,
        "Te128": (31.74 + 31.74) / 2,
        "Te130": (34.08 + 34.08) / 2,
    },
    "I": {
        "I127": 100.0,
    },
    "Xe": {
        "Xe124": (0.095 + 0.095) / 2,
        "Xe126": (0.089 + 0.089) / 2,
        "Xe128": (1.91 + 1.91) / 2,
        "Xe129": (26.4 + 26.4) / 2,
        "Xe130": (4.071 + 4.071) / 2,
        "Xe131": (21.232 + 21.232) / 2,
        "Xe132": (26.909 + 26.909) / 2,
        "Xe134": (10.436 + 10.436) / 2,
        "Xe136": (8.857 + 8.857) / 2,
    },
    "Cs": {
        "Cs133": 100.0,
    },
    "Ba": {
        "Ba130": (0.11 + 0.11) / 2,
        "Ba132": (0.1 + 0.1) / 2,
        "Ba134": (2.42 + 2.42) / 2,
        "Ba135": (6.59 + 6.59) / 2,
        "Ba136": (7.85 + 7.85) / 2,
        "Ba137": (11.23 + 11.23) / 2,
        "Ba138": (71.7 + 71.7) / 2,
    },
    "La": {
        "La138": (0.08881 + 0.08881) / 2,
        "La139": (99.91119 + 99.91119) / 2,
    },
    "Ce": {
        "Ce136": (0.186 + 0.186) / 2,
        "Ce138": (0.251 + 0.251) / 2,
        "Ce140": (88.449 + 88.449) / 2,
        "Ce142": (11.114 + 11.114) / 2,
    },
    "Pr": {
        "Pr141": 100.0,
    },
    "Nd": {
        "Nd142": (27.153 + 27.153) / 2,
        "Nd143": (12.173 + 12.173) / 2,
        "Nd144": (23.798 + 23.798) / 2,
        "Nd145": (8.293 + 8.293) / 2,
        "Nd146": (17.189 + 17.189) / 2,
        "Nd148": (5.756 + 5.756) / 2,
        "Nd150": (5.638 + 5.638) / 2,
    },
    "Sm": {
        "Sm144": (3.08 + 3.08) / 2,
        "Sm147": (15.0 + 15.0) / 2,
        "Sm149": (13.82 + 13.82) / 2,
        "Sm150": (7.37 + 7.37) / 2,
        "Sm152": (26.74 + 26.74) / 2,
        "Sm154": (22.74 + 22.74) / 2,
    },
    "Eu": {
        "Eu151": (47.81 + 47.81) / 2,
        "Eu153": (52.19 + 52.19) / 2,
    },
    "Gd": {
        "Gd152": (0.2 + 0.2) / 2,
        "Gd154": (2.18 + 2.18) / 2,
        "Gd155": (14.8 + 14.8) / 2,
        "Gd156": (20.47 + 20.47) / 2,
        "Gd157": (15.65 + 15.65) / 2,
        "Gd158": (24.84 + 24.84) / 2,
        "Gd160": (21.86 + 21.86) / 2,
    },
    "Tb": {
        "Tb159": 100.0,
    },
    "Dy": {
        "Dy156": (0.056 + 0.056) / 2,
        "Dy158": (0.095 + 0.095) / 2,
        "Dy160": (2.329 + 2.329) / 2,
        "Dy161": (18.889 + 18.889) / 2,
        "Dy162": (25.475 + 25.475) / 2,
        "Dy163": (24.896 + 24.896) / 2,
        "Dy164": (28.26 + 28.26) / 2,
    },
    "Ho": {
        "Ho165": 100.0,
    },
    "Er": {
        "Er162": (0.139 + 0.139) / 2,
        "Er164": (1.601 + 1.601) / 2,
        "Er166": (33.503 + 33.503) / 2,
        "Er167": (22.869 + 22.869) / 2,
        "Er168": (26.978 + 26.978) / 2,
        "Er170": (14.91 + 14.91) / 2,
    },
    "Tm": {
        "Tm169": 100.0,
    },
    "Yb": {
        "Yb168": (0.123 + 0.123) / 2,
        "Yb170": (2.982 + 2.982) / 2,
        "Yb171": (14.086 + 14.086) / 2,
        "Yb172": (21.686 + 21.686) / 2,
        "Yb173": (16.103 + 16.103) / 2,
        "Yb174": (32.025 + 32.025) / 2,
        "Yb176": (12.995 + 12.995) / 2,
    },
    "Lu": {
        "Lu175": (97.401 + 97.401) / 2,
        "Lu176": (2.599 + 2.599) / 2,
    },
    "Hf": {
        "Hf174": (0.16 + 0.16) / 2,
        "Hf176": (5.26 + 5.26) / 2,
        "Hf177": (18.6 + 18.6) / 2,
        "Hf178": (27.28 + 27.28) / 2,
        "Hf179": (13.62 + 13.62) / 2,
        "Hf180": (35.08 + 35.08) / 2,
    },
    "Ta": {
        "Ta180": (0.01201 + 0.01201) / 2,
        "Ta181": (99.98799 + 99.98799) / 2,
    },
    "W": {
        "W180": (0.12 + 0.12) / 2,
        "W182": (26.5 + 26.5) / 2,
        "W183": (14.31 + 14.31) / 2,
        "W184": (30.64 + 30.64) / 2,
        "W186": (28.43 + 28.43) / 2,
    },
    "Re": {
        "Re185": (37.4 + 37.4) / 2,
        "Re187": (62.6 + 62.6) / 2,
    },
    "Os": {
        "Os184": (0.02 + 0.02) / 2,
        "Os186": (1.59 + 1.59) / 2,
        "Os187": (1.97 + 1.97) / 2,
        "Os188": (13.24 + 13.24) / 2,
        "Os189": (16.15 + 16.15) / 2,
        "Os190": (26.26 + 26.26) / 2,
        "Os192": (40.78 + 40.78) / 2,
    },
    "Ir": {
        "Ir191": (37.3 + 37.3) / 2,
        "Ir193": (62.7 + 62.7) / 2,
    },
    "Pt": {
        "Pt190": (0.012 + 0.012) / 2,
        "Pt192": (0.782 + 0.782) / 2,
        "Pt194": (32.864 + 32.864) / 2,
        "Pt195": (33.77 + 33.77) / 2,
        "Pt196": (25.21 + 25.21) / 2,
        "Pt198": (7.356 + 7.356) / 2,
    },
    "Au": {
        "Au197": 100.0,
    },
    "Hg": {
        "Hg196": (0.15 + 0.15) / 2,
        "Hg198": (10.04 + 10.04) / 2,
        "Hg199": (16.94 + 16.94) / 2,
        "Hg200": (23.14 + 23.14) / 2,
        "Hg201": (13.17 + 13.17) / 2,
        "Hg202": (29.74 + 29.74) / 2,
        "Hg204": (6.82 + 6.82) / 2,
    },
    "Tl": {
        "Tl203": (29.44 + 29.59) / 2,
        "Tl205": (70.41 + 70.56) / 2,
    },
    "Pb": {
        "Pb204": (1.4 + 1.4) / 2,
        "Pb206": (24.1 + 24.1) / 2,
        "Pb207": (22.1 + 22.1) / 2,
        "Pb208": (52.4 + 52.4) / 2,
    },
    "Bi": {
        "Bi209": 100.0,
    },
    "Th": {
        "Th230": (0.02 + 0.02) / 2,
        "Th232": (99.98 + 99.98) / 2,
    },
    "Pa": {
        "Pa231": 100.0,
    },
    "U": {
        "U234": (0.0054 + 0.0054) / 2,
        "U235": (0.7204 + 0.7204) / 2,
        "U238": (99.2742 + 99.2742) / 2,
    },
}